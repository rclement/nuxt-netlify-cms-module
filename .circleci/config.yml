orbs:
  node: circleci/node@0.0.3
  npm: ci-tools/npm@dev:310ebff583bdd4073a51680cef9b2180e5a598d3

version: 2.1

defaults: &defaults
  executor: node/node

jobs:
  build-job:
    <<: *defaults
    steps:
      # Checkout repository
      - checkout

      # Restore cache
      - restore_cache:
          key: yarn-{{ checksum "yarn.lock" }}

      # Disable yarn progress bar for perf
      - run:
          name: Disabling yarn progress bar (performance)
          command: yarn config set no-progress

      # Disable yarn engine compatibility errors
      - run:
          name: Disabling yarn engine compatibility errors
          command: yarn config set ignore-engines true

      # Greenkeeper-lockfile
      - run:
          name: Installing greenkeeper-lockfile
          command: yarn global add greenkeeper-lockfile@1

      # Sonar-scanner
      - run:
          name: Installing sonar-scanner
          command: yarn global add sonarqube-scanner

      # Install dependencies
      - run:
          name: Installing dependencies
          command: yarn

      # Keep cache
      - save_cache:
          key: yarn-{{ checksum "yarn.lock" }}
          paths:
            - "node_modules"
            - "/root/.sonar"

      # Update yarn.lock
      - run:
          name: Updating lockfile
          command: greenkeeper-lockfile-update

      # Test
      - run:
          name: Testing
          command: yarn test

      # Coverage
      - run:
          name: Analyzing code & uploading test coverage
          command: sonar-scanner -Dsonar.login=$SONAR_TOKEN -Dsonar.branch.name=$CIRCLE_BRANCH

      # Upload yarn.lock
      - run:
          name: Uploading lockfile
          command: greenkeeper-lockfile-upload

      - persist_to_workspace:
          root: .
          paths:
            - dist/*
            - .circleci/*

workflows:
  version: 2
  build:
    jobs:
      - build-job
      - npm/publish:
          <<: *defaults
          requires:
            - build-job
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
          workspace-path: .
